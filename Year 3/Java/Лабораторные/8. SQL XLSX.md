# Задание
В файле 3.xls приведён фрагмент базы данных «Продукты» о поставках товаров в магазины районов города. База данных состоит из трёх таблиц. Таблица «Движение товаров» содержит записи о поставках товаров в магазины в течение первой декады июня 2021 г., а также информацию о проданных товарах. Поле Тип операции содержит значение Поступление или Продажа, а в соответствующее поле Количество упаковок, шт. занесена информация о том, сколько упаковок товара поступило в магазин или было продано в течение дня. Таблица «Товар» содержит информацию об основных характеристиках каждого товара. Таблица «Магазин» содержит информацию о местонахождении магазинов. На рисунке приведена схема указанной базы данных.
![[Assets/Pasted image 20251127145347.png]]
Требуется в одной из СУБД (MySQL, SQLite, H2 и др.) создать соответствующую базу данных. Заполнить базу данными аналогично файлу 3.xls или импортировать данные из xls файла в созданную базу (что гораздо лучше!).

1. Используя информацию из базы данных, определите общую стоимость (в рублях) товаров Молокозаводов № 1 и № 2, проданных за указанный период в магазинах Заречного района.
# Исходный код
```java
package org.example;

import java.io.File;
import java.io.FileInputStream;
import java.sql.*;
import java.text.ParseException;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.Scanner;

import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.ss.usermodel.*;

//TIP To <b>Run</b> code, press <shortcut actionId="Run"/> or
// click the <icon src="AllIcons.Actions.Execute"/> icon in the gutter.
public class Main {
    private static final String DB_URL = "jdbc:sqlite:products.db";
    private static final String EXCEL_FILE = "3.xls";

    public static void main(String[] args) {
        try (Scanner scanner = new Scanner(System.in)){
            createDatabaseAndImportFromExcel();
			System.out.println("Существуют данные между 01/06/2021 и 08/06/2021");
            System.out.print("Введите начальную дату периода (dd/MM/yyyy): ");
            String startDate = scanner.nextLine().trim();

            System.out.print("Введите конечную дату периода (dd/MM/yyyy): ");
            String endDate = scanner.nextLine().trim();
            double totalCost = calculateTotalCost(startDate, endDate);
            System.out.println("Общая стоимость товаров Молокозаводов №1 и №2,\n" +
                    "проданных в магазинах Заречного района: " + totalCost + " руб.");

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private static void createDatabaseAndImportFromExcel() throws Exception {
        try (Connection conn = DriverManager.getConnection(DB_URL);
             Statement stmt = conn.createStatement();
             FileInputStream fis = new FileInputStream(new File(EXCEL_FILE));
             Workbook workbook = new HSSFWorkbook(fis)) {

            createTables(stmt);

            importMovementData(workbook.getSheetAt(0), conn); // Движение товаров
            importProductData(workbook.getSheetAt(1), conn);  // Товар
            importStoreData(workbook.getSheetAt(2), conn);    // Магазин

            System.out.println("База данных создана и заполнена");
        }
    }

    private static void createTables(Statement stmt) throws SQLException {
        stmt.execute("DROP TABLE IF EXISTS Движение_товаров");
        stmt.execute("DROP TABLE IF EXISTS Товар");
        stmt.execute("DROP TABLE IF EXISTS Магазин");

        stmt.execute("""
            CREATE TABLE Магазин (
                ID_магазина TEXT PRIMARY KEY,
                Район TEXT,
                Адрес TEXT
            )
        """);

        stmt.execute("""
            CREATE TABLE Товар (
                Артикул INTEGER PRIMARY KEY,
                Отдел TEXT,
                Наименование_товара TEXT,
                Ед_изм TEXT,
                Количество_в_упаковке REAL,
                Поставщик TEXT
            )
        """);

        stmt.execute("""
            CREATE TABLE Движение_товаров (
                ID_операции INTEGER PRIMARY KEY,
                Дата TEXT,
                ID_магазина TEXT,
                Артикул INTEGER,
                Количество_упаковок INTEGER,
                Тип_операции TEXT,
                Цена_руб_шт REAL,
                FOREIGN KEY (ID_магазина) REFERENCES Магазин(ID_магазина),
                FOREIGN KEY (Артикул) REFERENCES Товар(Артикул)
            )
        """);

        System.out.println("Таблицы созданы");
    }

    private static void importMovementData(Sheet sheet, Connection conn) throws SQLException {
        String insertSQL = """
            INSERT INTO Движение_товаров
            (ID_операции, Дата, ID_магазина, Артикул, Количество_упаковок, Тип_операции, Цена_руб_шт)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        """;

        conn.setAutoCommit(false);

        try (PreparedStatement pstmt = conn.prepareStatement(insertSQL)) {
            int rowCount = 0;
            int batchSize = 500;
            for (int i = 1; i <= sheet.getLastRowNum(); i++) {
                Row row = sheet.getRow(i);
                if (row == null) continue;

                Cell firstCell = row.getCell(0);
                if (firstCell == null || firstCell.getCellType() == CellType.BLANK) {
                    continue;
                }

                pstmt.setInt(1, (int) getNumericValue(row.getCell(0)));        // ID операции
                pstmt.setString(2, getCellValueAsString(row.getCell(1)));      // Дата
                pstmt.setString(3, getCellValueAsString(row.getCell(2)));      // ID магазина
                pstmt.setInt(4, (int) getNumericValue(row.getCell(3)));        // Артикул
                pstmt.setInt(5, (int) getNumericValue(row.getCell(4)));        // Количество упаковок
                pstmt.setString(6, getCellValueAsString(row.getCell(5)));      // Тип операции
                pstmt.setDouble(7, getNumericValue(row.getCell(6)));           // Цена

                pstmt.addBatch();
                rowCount++;

                if (rowCount % batchSize == 0) {
                    pstmt.executeBatch();
                    conn.commit();
                    System.out.println("Импортировано 'Движение_товаров': " + rowCount);
                }
            }

            pstmt.executeBatch();
            conn.commit();
            System.out.println("Импортировано 'Движение_товаров': " + rowCount + " из " + sheet.getLastRowNum());
            conn.setAutoCommit(true);
        } catch (SQLException e) {
            conn.rollback();
            conn.setAutoCommit(true);
            throw e;
        }
    }

    private static void importProductData(Sheet sheet, Connection conn) throws SQLException {
        String insertSQL = """
            INSERT INTO Товар
            (Артикул, Отдел, Наименование_товара, Ед_изм, Количество_в_упаковке, Поставщик)
            VALUES (?, ?, ?, ?, ?, ?)
        """;

        try (PreparedStatement pstmt = conn.prepareStatement(insertSQL)) {
            int rowCount = 0;
            for (int i = 1; i <= sheet.getLastRowNum(); i++) {
                Row row = sheet.getRow(i);
                if (row == null) continue;

                Cell firstCell = row.getCell(0);
                if (firstCell == null || firstCell.getCellType() == CellType.BLANK) {
                    continue;
                }

                pstmt.setInt(1, (int) getNumericValue(row.getCell(0)));        // Артикул
                pstmt.setString(2, getCellValueAsString(row.getCell(1)));      // Отдел
                pstmt.setString(3, getCellValueAsString(row.getCell(2)));      // Наименование товара
                pstmt.setString(4, getCellValueAsString(row.getCell(3)));      // Ед. изм
                pstmt.setDouble(5, getNumericValue(row.getCell(4)));           // Количество в упаковке
                pstmt.setString(6, getCellValueAsString(row.getCell(5)));      // Поставщик

                pstmt.executeUpdate();
                rowCount++;
            }
            System.out.println("Импортировано 'Товар': " + rowCount);
        }
    }

    private static void importStoreData(Sheet sheet, Connection conn) throws SQLException {
        String insertSQL = """
            INSERT INTO Магазин
            (ID_магазина, Район, Адрес)
            VALUES (?, ?, ?)
        """;

        try (PreparedStatement pstmt = conn.prepareStatement(insertSQL)) {
            int rowCount = 0;
            for (int i = 1; i <= sheet.getLastRowNum(); i++) {
                Row row = sheet.getRow(i);
                if (row == null) continue;

                Cell firstCell = row.getCell(0);
                if (firstCell == null || firstCell.getCellType() == CellType.BLANK) {
                    continue;
                }

                pstmt.setString(1, getCellValueAsString(row.getCell(0)));      // ID магазина
                pstmt.setString(2, getCellValueAsString(row.getCell(1)));      // Район
                pstmt.setString(3, getCellValueAsString(row.getCell(2)));      // Адрес

                pstmt.executeUpdate();
                rowCount++;
            }
            System.out.println("Импортировано 'Магазин': " + rowCount);
        }
    }

    private static String getCellValueAsString(Cell cell) {
        if (cell == null) return "";

        return switch (cell.getCellType()) {
            case STRING -> cell.getStringCellValue().trim();
            case NUMERIC -> {
                if (DateUtil.isCellDateFormatted(cell)) {
                    yield cell.getLocalDateTimeCellValue().toString();
                } else {
                    double value = cell.getNumericCellValue();
                    if (value == (long) value) {
                        yield String.valueOf((long) value);
                    }
                    yield String.valueOf(value);
                }
            }
            default -> throw new RuntimeException("Failed to parse numeric value");
        };
    }

    private static double getNumericValue(Cell cell) {
        if (cell == null) return 0.0;

        return switch (cell.getCellType()) {
            case NUMERIC -> cell.getNumericCellValue();
            case STRING -> {
                try {
                    yield Double.parseDouble(cell.getStringCellValue().trim());
                } catch (NumberFormatException e) {
                    yield 0.0;
                }
            }
            default -> throw new RuntimeException("Failed to parse numeric value");
        };
    }

    private static double calculateTotalCost(String startDate, String endDate) throws SQLException {
        String query = """
            SELECT SUM(д.Количество_упаковок * д.Цена_руб_шт) AS total_cost
            FROM Движение_товаров д
            JOIN Товар т ON д.Артикул = т.Артикул
            JOIN Магазин м ON д.ID_магазина = м.ID_магазина
            WHERE д.Тип_операции = 'Продажа'
              AND м.Район = 'Заречный'
              AND (т.Поставщик = 'Молокозавод №1' OR т.Поставщик = 'Молокозавод №2')
              AND д.Дата >= ?
              AND д.Дата <= ?
        """;

        DateTimeFormatter format = DateTimeFormatter.ofPattern("dd/MM/yyyy");

        LocalDate start = LocalDate.parse(startDate, format);
        LocalDate end = LocalDate.parse(endDate, format);

        try (Connection conn = DriverManager.getConnection(DB_URL);
             PreparedStatement pstmt = conn.prepareStatement(query)) {

            pstmt.setObject(1, start);
            pstmt.setObject(2, end);

            try (ResultSet rs = pstmt.executeQuery()) {
                if (rs.next()) {
                    double result = rs.getDouble("total_cost");
                    if (rs.wasNull()) {
                        return 0.0;
                    }
                    return result;
                }
            }
        }

        return 0.0;
    }
}

```
# Реализация
1. Заполнение выполнено путём чтения каждой "страницы" таблицы, и последующего чтения каждой строки по ячейкам. После этого, данные вносятся простым `INSERT`
2. Для вывода результата, производится `SELECT SUM()` с использованием `JOIN` для объединения таблиц и `WHERE` для фильтрации
# Результат выполнения
![[Assets/Pasted image 20251127150304.png]]
![[Assets/Pasted image 20251127150834.png]]
![[Assets/Pasted image 20260127173814.png]]